name: Run Experiment

on:
    workflow_dispatch:  # Manual trigger only
        # inputs:
        #     commit_sha:
        #         description: 'Commit SHA to run the experiment'
        #         required: true
        #         default: 'main'

jobs:
    run-experiment-chunk:
        runs-on: ubuntu-latest

        continue-on-error: true

        strategy:
            matrix:
              chunk: [0, 1]
              # chunk: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3
            #   with:
            #     ref: ${{ github.event.inputs.commit_sha }}

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.11.9'

            - name: Cache Python packages
              uses: actions/cache@v3
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('**/*.whl') }}
                  restore-keys: |
                    ${{ runner.os }}-pip-

            - name: Install Discopygal
              run: |
                python -m pip install --upgrade pip
                pip install -v discopygal_taucgl-1.2.0-py3-none-any.whl

            - name: Run Experiment Script
              run: python run_experiment.py experiment_drrt_star.py ${{ matrix.chunk }} 10

            - name: Upload CSV Files as Artifact
              uses: actions/upload-artifact@v3
              with:
                name: results
                path: ./results
                retention-days: 7  # Keep artifacts for 7 days

    sum_results:
        runs-on: ubuntu-latest
        needs: run-experiment-chunk

        steps:
          - name: Download Results
            uses: actions/download-artifact@v3

          - name: Process results
            run: python run_experiment.py end

          - name: Re-upload Updated Results
            uses: actions/upload-artifact@v3
            with:
                name: results
                path: ./results
                retention-days: 7  # Keep artifacts for 7 days
